<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äººç”Ÿæ¨¡æ“¬éŠæˆ² API æ¸¬è©¦</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
            line-height: 1.6;
        }
        h1 {
            text-align: center;
            color: #a855f7;
            margin-bottom: 30px;
        }
        h2 {
            color: #c084fc;
            border-bottom: 2px solid #3b3b5c;
            padding-bottom: 10px;
        }
        .section {
            background: #16213e;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        .config {
            background: #0f3460;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #a5b4fc;
            font-weight: 500;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #3b3b5c;
            border-radius: 8px;
            background: #1a1a2e;
            color: #eee;
            font-size: 14px;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #a855f7;
        }
        button {
            background: linear-gradient(135deg, #a855f7, #6366f1);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(168, 85, 247, 0.4);
        }
        button:disabled {
            background: #4b5563;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .response {
            background: #0d1b2a;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            white-space: pre-wrap;
            word-break: break-word;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
        }
        .error {
            color: #f87171;
        }
        .success {
            color: #4ade80;
        }
        .image-container {
            margin-top: 15px;
            text-align: center;
        }
        .image-container img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
        .options-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }
        .custom-option-container {
            background: #1e3a5f;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        .custom-option-container input {
            margin-bottom: 10px;
        }
        .custom-option-container button {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        .custom-option-container button:hover {
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        .option-btn {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            text-align: left;
            padding: 15px;
        }
        .option-btn:hover {
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        .game-state {
            background: #1e3a5f;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .game-state h3 {
            margin: 0 0 10px 0;
            color: #60a5fa;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #ffffff30;
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
            vertical-align: middle;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .hidden {
            display: none;
        }
        .status-bar {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }
        .status-item {
            background: #374151;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>ğŸ® äººç”Ÿæ¨¡æ“¬éŠæˆ² API æ¸¬è©¦</h1>

    <!-- è¨­å®šå€ -->
    <div class="section config">
        <h2>âš™ï¸ API è¨­å®š</h2>
        <label for="apiUrl">API Base URL</label>
        <input type="text" id="apiUrl" value="https://3jdgsl5ne3.execute-api.us-east-1.amazonaws.com/Prod">

        <label for="knowledgeBaseId">Knowledge Base ID</label>
        <input type="text" id="knowledgeBaseId" placeholder="è¼¸å…¥ä½ çš„ Knowledge Base ID">
    </div>

    <!-- éŠæˆ²ç‹€æ…‹ -->
    <div class="section hidden" id="gameStateSection">
        <h2>ğŸ“Š ç›®å‰éŠæˆ²ç‹€æ…‹</h2>
        <div class="game-state">
            <div class="status-bar">
                <span class="status-item">ğŸ« Session: <span id="currentSessionId">-</span></span>
                <span class="status-item">ğŸ¯ ç›®æ¨™: <span id="currentGoal">-</span></span>
            </div>
            <div class="status-bar" style="margin-top: 10px;">
                <span class="status-item" style="background: #7c3aed;">ğŸ­ éšæ®µ: <span id="currentPhase">-</span></span>
                <span class="status-item" style="background: #2563eb;">ğŸ“ é€²åº¦: <span id="currentProgress">-</span></span>
                <span class="status-item" style="background: #059669;">â³ å‰©é¤˜: <span id="turnsLeft">-</span> å›åˆ</span>
            </div>
        </div>
        <div id="currentBackground"></div>
        <div id="currentSummary"></div>
    </div>

    <!-- Step 1: ç”ŸæˆèƒŒæ™¯ -->
    <div class="section">
        <h2>1ï¸âƒ£ ç”ŸæˆèƒŒæ™¯ (generate-background)</h2>
        <p>é–‹å§‹æ–°éŠæˆ²ï¼Œç”Ÿæˆè§’è‰²èƒŒæ™¯ã€èº«ä»½å’Œäººç”Ÿç›®æ¨™ã€‚</p>
        <button onclick="generateBackground()" id="btnBackground">é–‹å§‹æ–°éŠæˆ²</button>
        <div id="backgroundResponse" class="response hidden"></div>
        <div id="backgroundImage" class="image-container hidden"></div>
    </div>

    <!-- Step 2: ç”Ÿæˆæ•…äº‹ -->
    <div class="section">
        <h2>2ï¸âƒ£ ç”Ÿæˆæ•…äº‹äº‹ä»¶ (generate-story)</h2>
        <p>æ ¹æ“šç›®å‰ç‹€æ…‹ç”Ÿæˆæ–°çš„äººç”Ÿäº‹ä»¶å’Œé¸é …ã€‚</p>
        <button onclick="generateStory()" id="btnStory" disabled>ç”Ÿæˆäº‹ä»¶</button>
        <div id="storyResponse" class="response hidden"></div>
        <div id="storyImage" class="image-container hidden"></div>
        <div id="storyOptions" class="options-container hidden"></div>
    </div>

    <!-- Step 3: è§£æ±ºäº‹ä»¶ -->
    <div class="section">
        <h2>3ï¸âƒ£ è§£æ±ºäº‹ä»¶ (resolve-event)</h2>
        <p>é¸æ“‡ä¸€å€‹é¸é …æˆ–è¼¸å…¥è‡ªè¨‚é¸é …ä¾†è§£æ±ºç›®å‰çš„äº‹ä»¶ã€‚</p>
        <div id="customOptionContainer" class="custom-option-container hidden">
            <label for="customOption">æˆ–è¼¸å…¥è‡ªè¨‚é¸é …ï¼š</label>
            <input type="text" id="customOption" placeholder="è¼¸å…¥ä½ æƒ³åšçš„é¸æ“‡...">
            <button onclick="resolveWithCustomOption()" id="btnCustomOption">é€å‡ºè‡ªè¨‚é¸é …</button>
        </div>
        <div id="resolveResponse" class="response hidden"></div>
        <div id="resolveImage" class="image-container hidden"></div>
    </div>

    <!-- Step 4: ç”Ÿæˆçµå±€ -->
    <div class="section">
        <h2>4ï¸âƒ£ ç”Ÿæˆçµå±€ (generate-result)</h2>
        <p>çµæŸéŠæˆ²ï¼Œç”Ÿæˆäººç”Ÿç¸½çµå’Œçµå±€ã€‚</p>
        <button onclick="generateResult()" id="btnResult" disabled>çµæŸéŠæˆ²</button>
        <div id="resultResponse" class="response hidden"></div>
        <div id="resultImage" class="image-container hidden"></div>
    </div>

    <!-- Raw Response -->
    <div class="section">
        <h2>ğŸ“ å®Œæ•´ API å›æ‡‰</h2>
        <div id="rawResponse" class="response">ç­‰å¾… API å‘¼å«...</div>
    </div>

    <script>
        // éŠæˆ²ç‹€æ…‹
        let gameState = {
            sessionId: null,
            currentEvent: null,
            lifeGoal: null,
            background: null,
            playerIdentity: null
        };

        function getApiUrl() {
            return document.getElementById('apiUrl').value.replace(/\/$/, '');
        }

        function getKnowledgeBaseId() {
            return document.getElementById('knowledgeBaseId').value;
        }

        function showLoading(btnId) {
            const btn = document.getElementById(btnId);
            btn.disabled = true;
            btn.innerHTML += '<span class="loading"></span>';
        }

        function hideLoading(btnId, text) {
            const btn = document.getElementById(btnId);
            btn.disabled = false;
            btn.textContent = text;
        }

        function showResponse(elementId, data, isError = false) {
            const el = document.getElementById(elementId);
            el.classList.remove('hidden', 'error', 'success');
            el.classList.add(isError ? 'error' : 'success');
            el.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
        }

        function showImage(elementId, base64Image) {
            const el = document.getElementById(elementId);
            if (base64Image) {
                el.innerHTML = `<img src="data:image/png;base64,${base64Image}" alt="Generated Image">`;
                el.classList.remove('hidden');
            } else {
                el.classList.add('hidden');
            }
        }

        function updateGameState() {
            const section = document.getElementById('gameStateSection');
            if (gameState.sessionId) {
                section.classList.remove('hidden');
                document.getElementById('currentSessionId').textContent = gameState.sessionId.substring(0, 8) + '...';
                document.getElementById('currentGoal').textContent = gameState.lifeGoal || '-';
                document.getElementById('currentBackground').textContent = gameState.background || '';
            }
        }

        function showRawResponse(data) {
            document.getElementById('rawResponse').textContent = JSON.stringify(data, null, 2);
        }

        async function apiCall(endpoint, body) {
            const response = await fetch(`${getApiUrl()}${endpoint}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            const data = await response.json();
            showRawResponse(data);
            if (!response.ok) {
                throw new Error(data.message || 'API Error');
            }
            return data;
        }

        async function generateBackground() {
            showLoading('btnBackground');
            try {
                const data = await apiCall('/generate-background', {
                    knowledge_base_id: getKnowledgeBaseId()
                });

                gameState.sessionId = data.session_id;
                gameState.lifeGoal = data.life_goal;
                gameState.background = data.background;
                gameState.playerIdentity = data.player_identity;

                showResponse('backgroundResponse', {
                    session_id: data.session_id,
                    background: data.background,
                    player_identity: data.player_identity,
                    life_goal: data.life_goal
                });
                showImage('backgroundImage', data.image);
                updateGameState();

                // å•Ÿç”¨ä¸‹ä¸€æ­¥
                document.getElementById('btnStory').disabled = false;
                document.getElementById('btnResult').disabled = false;

            } catch (error) {
                showResponse('backgroundResponse', `éŒ¯èª¤: ${error.message}`, true);
            }
            hideLoading('btnBackground', 'é–‹å§‹æ–°éŠæˆ²');
        }

        function updateGameProgress(progress) {
            if (progress) {
                document.getElementById('currentPhase').textContent = progress.phase || '-';
                document.getElementById('currentProgress').textContent = `${progress.turn}/${progress.total_turns}`;
                document.getElementById('turnsLeft').textContent = progress.turns_left;

                // å¦‚æœéŠæˆ²å¿«çµæŸï¼Œæ”¹è®Šé¡è‰²æç¤º
                if (progress.turns_left <= 3) {
                    document.getElementById('turnsLeft').parentElement.style.background = '#dc2626';
                }
            }
        }

        async function generateStory() {
            if (!gameState.sessionId) {
                alert('è«‹å…ˆé–‹å§‹æ–°éŠæˆ²ï¼');
                return;
            }

            showLoading('btnStory');
            try {
                const data = await apiCall('/generate-story', {
                    session_id: gameState.sessionId
                });

                // æª¢æŸ¥éŠæˆ²æ˜¯å¦å·²çµæŸ
                if (data.should_generate_result) {
                    alert('éŠæˆ²å·²çµæŸï¼è«‹é»æ“Šã€ŒçµæŸéŠæˆ²ã€æŸ¥çœ‹çµå±€ã€‚');
                    hideLoading('btnStory', 'ç”Ÿæˆäº‹ä»¶');
                    return;
                }

                gameState.currentEvent = {
                    event_id: data.event_id,
                    event_description: data.event_description
                };

                // æ›´æ–°éŠæˆ²é€²åº¦
                updateGameProgress(data.game_progress);

                showResponse('storyResponse', {
                    event_id: data.event_id,
                    event_description: data.event_description,
                    game_progress: data.game_progress
                });
                showImage('storyImage', data.image);

                // é¡¯ç¤ºé¸é …æŒ‰éˆ•
                const optionsContainer = document.getElementById('storyOptions');
                optionsContainer.innerHTML = '';
                optionsContainer.classList.remove('hidden');

                data.options.forEach(option => {
                    const btn = document.createElement('button');
                    btn.className = 'option-btn';
                    btn.textContent = option.description;
                    btn.onclick = () => resolveEvent(option.description);
                    optionsContainer.appendChild(btn);
                });

                // é¡¯ç¤ºè‡ªè¨‚é¸é …è¼¸å…¥æ¡†
                document.getElementById('customOptionContainer').classList.remove('hidden');
                document.getElementById('customOption').value = '';

            } catch (error) {
                showResponse('storyResponse', `éŒ¯èª¤: ${error.message}`, true);
            }
            hideLoading('btnStory', 'ç”Ÿæˆäº‹ä»¶');
        }

        async function resolveEvent(selectedOption) {
            if (!gameState.sessionId || !gameState.currentEvent) {
                alert('æ²’æœ‰å¯è§£æ±ºçš„äº‹ä»¶ï¼');
                return;
            }

            // ç¦ç”¨æ‰€æœ‰é¸é …æŒ‰éˆ•å’Œè‡ªè¨‚é¸é …
            document.querySelectorAll('.option-btn').forEach(btn => btn.disabled = true);
            document.getElementById('btnCustomOption').disabled = true;

            try {
                const data = await apiCall('/resolve-event', {
                    session_id: gameState.sessionId,
                    event: gameState.currentEvent,
                    selected_option: selectedOption
                });

                showResponse('resolveResponse', {
                    event_outcome: data.event_outcome,
                    updated_player_state: data.updated_player_state,
                    current_summary: data.current_summary
                });
                showImage('resolveImage', data.image);

                // æ›´æ–°æ‘˜è¦
                document.getElementById('currentSummary').textContent = `ğŸ“œ ${data.current_summary}`;

                // æ¸…ç©ºç›®å‰äº‹ä»¶
                gameState.currentEvent = null;

                // éš±è—é¸é …å€åŸŸ
                document.getElementById('storyOptions').classList.add('hidden');
                document.getElementById('customOptionContainer').classList.add('hidden');

                // è‡ªå‹•ç”Ÿæˆä¸‹ä¸€å€‹æ•…äº‹äº‹ä»¶
                await generateStory();

            } catch (error) {
                showResponse('resolveResponse', `éŒ¯èª¤: ${error.message}`, true);
                // ç™¼ç”ŸéŒ¯èª¤æ™‚é‡æ–°å•Ÿç”¨é¸é …æŒ‰éˆ•å’Œè‡ªè¨‚é¸é …
                document.querySelectorAll('.option-btn').forEach(btn => btn.disabled = false);
                document.getElementById('btnCustomOption').disabled = false;
            }
        }

        function resolveWithCustomOption() {
            const customOption = document.getElementById('customOption').value.trim();
            if (!customOption) {
                alert('è«‹è¼¸å…¥è‡ªè¨‚é¸é …å…§å®¹ï¼');
                return;
            }
            resolveEvent(customOption);
        }

        async function generateResult() {
            if (!gameState.sessionId) {
                alert('è«‹å…ˆé–‹å§‹æ–°éŠæˆ²ï¼');
                return;
            }

            showLoading('btnResult');
            try {
                const data = await apiCall('/generate-result', {
                    session_id: gameState.sessionId
                });

                showResponse('resultResponse', {
                    summary: data.summary,
                    ending_type: data.ending_type,
                    radar_scores: data.radar_scores
                });
                showImage('resultImage', data.image);

            } catch (error) {
                showResponse('resultResponse', `éŒ¯èª¤: ${error.message}`, true);
            }
            hideLoading('btnResult', 'çµæŸéŠæˆ²');
        }
    </script>
</body>
</html>
