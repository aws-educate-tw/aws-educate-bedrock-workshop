# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
# SPDX-License-Identifier: MIT-0

AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: SAM Template for Lambda Response with Bedrock Model Integration

Resources:
  # CloudWatch Log Group for API Gateway Access Logs
  ApiGatewayAccessLogs:
    Type: AWS::Logs::LogGroup
    Properties:
      RetentionInDays: 30
      LogGroupName: !Sub "/aws/apigateway/${AWS::StackName}/access-logs"

  # IAM Role for API Gateway to write to CloudWatch Logs
  ApiGatewayCloudWatchRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: apigateway.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonAPIGatewayPushToCloudWatchLogs

  # API Gateway Account Configuration
  ApiGatewayAccount:
    Type: AWS::ApiGateway::Account
    Properties:
      CloudWatchRoleArn: !GetAtt ApiGatewayCloudWatchRole.Arn

  ApiGW:
    Type: AWS::Serverless::Api
    DependsOn: ApiGatewayAccount
    Properties:
      StageName: Prod
      EndpointConfiguration:
        Type: REGIONAL
      Cors:
        AllowMethods: "'POST, GET, OPTIONS'"
        AllowHeaders: "'Content-Type, Authorization'"
        AllowOrigin: "'*'"
      AccessLogSetting:
        DestinationArn: !GetAtt ApiGatewayAccessLogs.Arn
        Format: '{"requestId":"$context.requestId","requestTime":"$context.requestTime","httpMethod":"$context.httpMethod","path":"$context.path","resourcePath":"$context.resourcePath","status":$context.status,"responseLength":$context.responseLength,"responseTime":$context.responseTime,"userAgent":"$context.identity.userAgent","sourceIp":"$context.identity.sourceIp","protocol":"$context.protocol","error.message":"$context.error.message","error.messageString":"$context.error.messageString"}'
      MethodSettings:
        - ResourcePath: "/*"
          HttpMethod: "*"
          LoggingLevel: INFO
          DataTraceEnabled: true
          MetricsEnabled: true

  ResponseFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: s3://workshop-demo-artifacts/lambda/lambda.zip
      Handler: index.handler
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      MemorySize: 256
      Timeout: 300
      Environment:
        Variables:
          BEDROCK_REGION: !Ref AWS::Region
          DDB_TABLE_NAME: !Ref GameSessionsTable
          KNOWLEDGE_BASE_ID: ""
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBCrudPolicy:
            TableName: !Ref GameSessionsTable
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - bedrock:InvokeModel
              Resource: "*"
            - Effect: Allow
              Action:
                - bedrock-runtime:InvokeModel
              Resource: "*"
            - Effect: Allow
              Action:
                - bedrock:Retrieve
              Resource: !Sub "arn:aws:bedrock:${AWS::Region}:${AWS::AccountId}:knowledge-base/*"
      Events:
        GenerateBackground:
          Type: Api
          Properties:
            Path: /generate-background
            Method: post
            RestApiId: !Ref ApiGW
        GenerateStory:
          Type: Api
          Properties:
            Path: /generate-story
            Method: post
            RestApiId: !Ref ApiGW
        ResolveEvent:
          Type: Api
          Properties:
            Path: /resolve-event
            Method: post
            RestApiId: !Ref ApiGW
        GenerateResult:
          Type: Api
          Properties:
            Path: /generate-result
            Method: post
            RestApiId: !Ref ApiGW
        DbHealth:
          Type: Api
          Properties:
            Path: /db-health
            Method: get
            RestApiId: !Ref ApiGW
        LambdaHealth:
          Type: Api
          Properties:
            Path: /lambda-health
            Method: get
            RestApiId: !Ref ApiGW

  GameSessionsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: GameSessions
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: session_id
          AttributeType: S
      KeySchema:
        - AttributeName: session_id
          KeyType: HASH
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true

  FrontendBucket:
    Type: AWS::S3::Bucket
    Properties:
      WebsiteConfiguration:
        IndexDocument: index.html
      PublicAccessBlockConfiguration:
        BlockPublicAcls: false
        BlockPublicPolicy: false
        IgnorePublicAcls: false
        RestrictPublicBuckets: false

  FrontendBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref FrontendBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: AllowPublicRead
            Effect: Allow
            Principal: "*"
            Action: s3:GetObject
            Resource: !Sub "${FrontendBucket.Arn}/*"

  FrontendDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        HttpVersion: http2
        DefaultRootObject: index.html
        Origins:
          - Id: FrontendS3Origin
            DomainName: !GetAtt FrontendBucket.RegionalDomainName
            S3OriginConfig: {}
          - Id: ApiOrigin
            DomainName: !Sub "${ApiGW}.execute-api.${AWS::Region}.amazonaws.com"
            OriginPath: "/Prod"
            CustomOriginConfig:
              OriginProtocolPolicy: https-only
        DefaultCacheBehavior:
          TargetOriginId: FrontendS3Origin
          ViewerProtocolPolicy: redirect-to-https
          ForwardedValues:
            QueryString: false
            Cookies:
              Forward: none
        CacheBehaviors:
          - PathPattern: "api/*"
            TargetOriginId: ApiOrigin
            ViewerProtocolPolicy: redirect-to-https
            AllowedMethods:
              - GET
              - HEAD
              - OPTIONS
              - PUT
              - POST
              - PATCH
              - DELETE
            CachedMethods:
              - GET
              - HEAD
              - OPTIONS
            ForwardedValues:
              QueryString: true
              Headers:
                - Authorization
                - Content-Type
              Cookies:
                Forward: all
            FunctionAssociations:
              - EventType: viewer-request
                FunctionARN: !GetAtt ApiPathRewriteFunction.FunctionARN

  ApiPathRewriteFunction:
    Type: AWS::CloudFront::Function
    Properties:
      Name: !Sub "${AWS::StackName}-api-path-rewrite"
      AutoPublish: true
      FunctionCode: |
        function handler(event) {
          var request = event.request;
          var uri = request.uri || '';
          if (uri.startsWith('/api/')) {
            request.uri = uri.substring(4) || '/';
          } else if (uri === '/api') {
            request.uri = '/';
          }
          return request;
        }
      FunctionConfig:
        Comment: "Strip /api prefix before sending to API Gateway"
        Runtime: cloudfront-js-1.0
  FrontendSeedRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: FrontendSeedS3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:PutObject
                Resource: !Sub "${FrontendBucket.Arn}/*"

  FrontendSeedFunction:
    Type: AWS::Lambda::Function
    Properties:
      Runtime: python3.11
      Handler: index.handler
      Role: !GetAtt FrontendSeedRole.Arn
      Timeout: 300
      Code:
        ZipFile: |
          import json
          import urllib.request
          import boto3
          import io
          import zipfile
          import mimetypes

          def send_response(event, context, status, reason=None):
              response_body = {
                  "Status": status,
                  "Reason": reason or "OK",
                  "PhysicalResourceId": event.get("PhysicalResourceId") or context.log_stream_name,
                  "StackId": event["StackId"],
                  "RequestId": event["RequestId"],
                  "LogicalResourceId": event["LogicalResourceId"],
                  "Data": {}
              }
              data = json.dumps(response_body).encode("utf-8")
              req = urllib.request.Request(
                  event["ResponseURL"],
                  data=data,
                  headers={"content-type": "", "content-length": str(len(data))},
                  method="PUT",
              )
              urllib.request.urlopen(req)

          def handler(event, context):
              if event["RequestType"] == "Delete":
                  send_response(event, context, "SUCCESS")
                  return

              try:
                  source_url = event["ResourceProperties"]["SourceUrl"]
                  dest_bucket = event["ResourceProperties"]["DestBucket"]
                  with urllib.request.urlopen(source_url) as response:
                      zip_bytes = io.BytesIO(response.read())

                  s3 = boto3.client("s3")
                  with zipfile.ZipFile(zip_bytes) as archive:
                      for name in archive.namelist():
                          if name.endswith("/"):
                              continue
                          content = archive.read(name)
                          content_type, _ = mimetypes.guess_type(name)
                          if not content_type:
                              content_type = "application/octet-stream"
                          s3.put_object(
                              Bucket=dest_bucket,
                              Key=name,
                              Body=content,
                              ContentType=content_type,
                          )

                  send_response(event, context, "SUCCESS")
              except Exception as exc:
                  send_response(event, context, "FAILED", str(exc))

  FrontendSeed:
    Type: Custom::FrontendSeed
    Properties:
      ServiceToken: !GetAtt FrontendSeedFunction.Arn
      SourceUrl: "https://workshop-demo-artifacts.s3.us-east-1.amazonaws.com/frontend/frontend.zip"
      DestBucket: !Ref FrontendBucket

  ApiGatewayInvokePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref ResponseFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ApiGW}/*/*"

Outputs:
  ApiBaseUrl:
    Description: "API Gateway base URL"
    Value: !Sub "https://${ApiGW}.execute-api.${AWS::Region}.amazonaws.com/Prod"
  FrontendBucketName:
    Description: "S3 bucket name for the frontend"
    Value: !Ref FrontendBucket
  FrontendUrl:
    Description: "Public website URL for the frontend"
    Value: !GetAtt FrontendBucket.WebsiteURL
  CloudFrontUrl:
    Description: "CloudFront distribution URL"
    Value: !Sub "https://${FrontendDistribution.DomainName}"
